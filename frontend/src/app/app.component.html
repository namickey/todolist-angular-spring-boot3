<ng-container *ngIf="viewModel$ | async as vm">
  <div class="app">
    <header class="app__header">
      <div>
        <p class="eyebrow">Spring Boot + Angular</p>
        <h1>📋 シンプル TODO</h1>
        <p class="caption">バックエンドの WebAPI とつながる Angular 実装です。</p>
      </div>
      <div class="meta">
        <button type="button" class="ghost" (click)="refresh()" [disabled]="vm.loading">再読込</button>
        <span class="meta__time">最終取得: {{ formatDate(vm.lastSyncedAt ?? undefined) }}</span>
      </div>
    </header>

    <section class="card">
      <div class="input-row">
        <label class="sr-only" for="new-title">やることを追加</label>
        <input
          id="new-title"
          type="text"
          maxlength="200"
          placeholder="やることを追加"
          [(ngModel)]="newTodoTitle"
          (keyup.enter)="addTodo()"
          [disabled]="vm.loading || isSubmittingNewTodo"
        />
        <button
          type="button"
          class="primary"
          (click)="addTodo()"
          [disabled]="vm.loading || isSubmittingNewTodo"
        >
          追加
        </button>
        <button
          type="button"
          class="danger"
          (click)="clearAll()"
          [disabled]="vm.loading || vm.totalCount === 0 || isClearingAll"
        >
          全削除
        </button>
      </div>
      <div class="status-row">
        <span>未完了 {{ vm.pendingCount }} 件</span>
        <span>完了 {{ vm.completedCount }} 件</span>
      </div>
      <p class="error" *ngIf="formError || vm.errorMessage">
        {{ formError || vm.errorMessage }}
      </p>
      <p class="muted" *ngIf="vm.loading">読み込み中...</p>
    </section>

    <section class="list-group">
      <div class="list-group__header">
        <h2>🔸 未完了</h2>
      </div>
      <ul>
        <ng-container *ngFor="let todo of vm.pendingTodos; trackBy: trackByTodo">
          <li [class.disabled]="vm.loading || isTodoMutating(todo.id)">
            <label class="checkbox">
              <input
                type="checkbox"
                [checked]="todo.completed"
                (change)="toggleCompleted(todo)"
                [disabled]="vm.loading || isTodoMutating(todo.id)"
              />
            </label>
            <div class="title">
              <ng-container *ngIf="editingTodoId === todo.id; else viewTitle">
                <input
                  class="edit-input"
                  [(ngModel)]="editingTitle"
                  (keyup.enter)="submitEdit(todo)"
                  [disabled]="isTodoMutating(todo.id)"
                />
                <button type="button" class="ghost" (click)="cancelEditing()">キャンセル</button>
              </ng-container>
              <ng-template #viewTitle>
                <span class="editable" (dblclick)="startEditing(todo)">{{ todo.title }}</span>
              </ng-template>
              <p class="timestamp">更新: {{ formatDate(todo.updatedAt) }}</p>
            </div>
            <button
              type="button"
              class="danger ghost"
              (click)="deleteTodo(todo)"
              [disabled]="vm.loading || isTodoMutating(todo.id)"
            >
              削除
            </button>
          </li>
        </ng-container>
        <li class="empty" *ngIf="!vm.pendingCount && !vm.loading">未完了のタスクはありません。</li>
      </ul>
    </section>

    <section class="list-group">
      <div class="list-group__header">
        <h2>✅ 完了</h2>
      </div>
      <ul>
        <ng-container *ngFor="let todo of vm.completedTodos; trackBy: trackByTodo">
          <li [class.disabled]="vm.loading || isTodoMutating(todo.id)">
            <label class="checkbox">
              <input
                type="checkbox"
                [checked]="todo.completed"
                (change)="toggleCompleted(todo)"
                [disabled]="vm.loading || isTodoMutating(todo.id)"
              />
            </label>
            <div class="title">
              <span class="completed">{{ todo.title }}</span>
              <p class="timestamp">完了: {{ formatDate(todo.updatedAt) }}</p>
            </div>
            <button
              type="button"
              class="danger ghost"
              (click)="deleteTodo(todo)"
              [disabled]="vm.loading || isTodoMutating(todo.id)"
            >
              削除
            </button>
          </li>
        </ng-container>
        <li class="empty" *ngIf="!vm.completedCount && !vm.loading">完了したタスクはまだありません。</li>
      </ul>
    </section>
  </div>
</ng-container>
